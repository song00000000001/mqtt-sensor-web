<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; script-src 'self' 'unsafe-inline' https://unpkg.com; connect-src wss://test.mosquitto.org:8081 wss://broker.hivemq.com:8000 wss://broker.emqx.io:8083">
    <title>ESP8266传感器监控</title>
    <script src="https://unpkg.com/mqtt@4.1.0/dist/mqtt.min.js"></script>
    <style id="main-style">
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .dashboard {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        .sensor-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin: 15px 0;
        }
        .sensor-card {
            width: 32%;
            margin-bottom: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
            box-sizing: border-box;
        }
        .sensor-card h2 {
            text-align: center;
            margin-top: 0;
        }
        .sensor-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
            margin: 5px 0;
            text-align: center;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #e9f7ef;
        }
        .status.warning {
            background: #fff3e0;
            border-left-color: #FF9800;
        }
        .status.error {
            background: #ffebee;
            border-left-color: #f44336;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #connectBtn {
            background-color: #4CAF50;
            color: white;
        }
        #connectBtn:hover {
            background-color: #45a049;
        }
        #connectBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #configBtn {
            background-color: #2196F3;
            color: white;
        }
        #configBtn:hover {
            background-color: #0b7dda;
        }
        .timestamp {
            color: #666;
            font-style: italic;
            text-align: right;
            margin-top: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 400px;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .modal-actions {
            margin-top: 20px;
            text-align: right;
        }
        @media (max-width: 600px) {
            .sensor-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <h1>环境传感器数据</h1>
        
        <div id="connectionStatus" class="status">
            <span id="statusText">正在初始化MQTT连接...</span>
            <span id="currentBroker"></span>
        </div>
        
        <div class="sensor-group">
            <div class="sensor-card">
                <h2>传感器1</h2>
                <h3>温度</h3>
                <div class="sensor-value" id="temperature1">-- °C</div>
                <h3>湿度</h3>
                <div class="sensor-value" id="humidity1">-- %</div>
                <h3>光照</h3>
                <div class="sensor-value" id="illuminance1">-- lx</div>
            </div>
            
            <div class="sensor-card">
                <h2>传感器2</h2>
                <h3>温度</h3>
                <div class="sensor-value" id="temperature2">-- °C</div>
                <h3>湿度</h3>
                <div class="sensor-value" id="humidity2">-- %</div>
                <h3>光照</h3>
                <div class="sensor-value" id="illuminance2">-- lx</div>
            </div>
            
            <div class="sensor-card">
                <h2>传感器3</h2>
                <h3>温度</h3>
                <div class="sensor-value" id="temperature3">-- °C</div>
                <h3>湿度</h3>
                <div class="sensor-value" id="humidity3">-- %</div>
                <h3>光照</h3>
                <div class="sensor-value" id="illuminance3">-- lx</div>
            </div>
        </div>
        
        <div class="timestamp" id="updateTime">更新时间: --</div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button id="connectBtn">连接MQTT</button>
            <button id="configBtn">服务器配置</button>
        </div>
    </div>
    
    <!-- 配置模态框 -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <h2>MQTT服务器配置</h2>
            <div class="input-group">
                <label for="mqttServer">服务器地址:</label>
                <input type="text" id="mqttServer" placeholder="wss://test.mosquitto.org:8081">
            </div>
            <div class="input-group">
                <label for="mqttTopic">主题:</label>
                <input type="text" id="mqttTopic" value="esp8266/sensor/data/202509062242">
            </div>
            <div class="modal-actions">
                <button id="cancelBtn">取消</button>
                <button id="saveBtn" style="background-color: #4CAF50;">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 配置存储
        const CONFIG_KEY = 'mqttConfig';
        const DEFAULT_CONFIG = {
            server: "wss://test.mosquitto.org:8081/mqtt",
            topic: "esp8266/sensor/data/202509062242"
        };

        // 状态变量
        let client = null;
        let isConnected = false;
        let lastUpdateTime = 0;
        
        // DOM元素
        const statusText = document.getElementById('statusText');
        const currentBroker = document.getElementById('currentBroker');
        const connectBtn = document.getElementById('connectBtn');
        const configBtn = document.getElementById('configBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');
        const configModal = document.getElementById('configModal');
        const mqttServerInput = document.getElementById('mqttServer');
        const mqttTopicInput = document.getElementById('mqttTopic');
        
        // 初始化配置
        let config = {...DEFAULT_CONFIG};
        const savedConfig = localStorage.getItem(CONFIG_KEY);
        if (savedConfig) {
            try {
                config = {...config, ...JSON.parse(savedConfig)};
            } catch (e) {
                console.error('配置解析失败', e);
            }
        }
        
        // 初始化页面
        mqttServerInput.value = config.server;
        mqttTopicInput.value = config.topic;
        
        // 连接/断开MQTT
        function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        }
        
        function connect() {
            if (isConnected) return;
            
            updateStatus("正在连接...");
            connectBtn.disabled = true;
            
            // 从配置获取连接参数
            const brokerUrl = config.server;
            const topic = config.topic;
            const clientId = 'web-client-' + Math.random().toString(16).substr(2, 8);
            
            currentBroker.textContent = `(服务器: ${brokerUrl.split('/')[2]})`;
            
            // 创建MQTT客户端
            client = mqtt.connect(brokerUrl, {
                clientId: clientId,
                clean: true,
                reconnectPeriod: 0
            });
            
            // 事件处理
            client.on('connect', () => {
                isConnected = true;
                updateStatus("已连接", true);
                connectBtn.textContent = "断开连接";
                connectBtn.disabled = false;
                
                client.subscribe(topic, (err) => {
                    if (err) {
                        updateStatus(`订阅失败: ${err.message}`, false);
                    }
                });
            });
            
            client.on('error', (err) => {
                updateStatus(`连接错误: ${err.message}`, false);
                connectBtn.textContent = "连接MQTT";
                connectBtn.disabled = false;
            });
            
            client.on('close', () => {
                if (isConnected) {
                    isConnected = false;
                    updateStatus("连接已断开");
                    connectBtn.textContent = "连接MQTT";
                }
            });
            
            client.on('message', (topic, message) => {
                try {
                    const data = JSON.parse(message.toString());
                    updateSensorData(data);
                    lastUpdateTime = Date.now();
                } catch (e) {
                    console.error('消息解析失败:', e);
                }
            });
        }
        
        function disconnect() {
            if (client && isConnected) {
                client.end();
            }
        }
        
        // 更新传感器数据
        function updateSensorData(data) {
            // 更新传感器1数据
            if (data.t1 !== undefined) {
                document.getElementById('temperature1').textContent = `${data.t1.toFixed(1)} °C`;
            }
            if (data.h1 !== undefined) {
                document.getElementById('humidity1').textContent = `${data.h1.toFixed(1)} %`;
            }
            if (data.i1 !== undefined) {
                document.getElementById('illuminance1').textContent = `${data.i1.toFixed(1)} lx`;
            }
            
            // 更新传感器2数据
            if (data.t2 !== undefined) {
                document.getElementById('temperature2').textContent = `${data.t2.toFixed(1)} °C`;
            }
            if (data.h2 !== undefined) {
                document.getElementById('humidity2').textContent = `${data.h2.toFixed(1)} %`;
            }
            if (data.i2 !== undefined) {
                document.getElementById('illuminance2').textContent = `${data.i2.toFixed(1)} lx`;
            }
            
            // 更新传感器3数据
            if (data.t3 !== undefined) {
                document.getElementById('temperature3').textContent = `${data.t3.toFixed(1)} °C`;
            }
            if (data.h3 !== undefined) {
                document.getElementById('humidity3').textContent = `${data.h3.toFixed(1)} %`;
            }
            if (data.i3 !== undefined) {
                document.getElementById('illuminance3').textContent = `${data.i3.toFixed(1)} lx`;
            }
            
            // 如果数据格式是数组形式（兼容旧格式）
            if (Array.isArray(data.t)) {
                if (data.t[0] !== undefined) {
                    document.getElementById('temperature1').textContent = `${data.t[0].toFixed(1)} °C`;
                }
                if (data.h[0] !== undefined) {
                    document.getElementById('humidity1').textContent = `${data.h[0].toFixed(1)} %`;
                }
                if (data.i[0] !== undefined) {
                    document.getElementById('illuminance1').textContent = `${data.i[0].toFixed(1)} lx`;
                }
                
                if (data.t[1] !== undefined) {
                    document.getElementById('temperature2').textContent = `${data.t[1].toFixed(1)} °C`;
                }
                if (data.h[1] !== undefined) {
                    document.getElementById('humidity2').textContent = `${data.h[1].toFixed(1)} %`;
                }
                if (data.i[1] !== undefined) {
                    document.getElementById('illuminance2').textContent = `${data.i[1].toFixed(1)} lx`;
                }
                
                if (data.t[2] !== undefined) {
                    document.getElementById('temperature3').textContent = `${data.t[2].toFixed(1)} °C`;
                }
                if (data.h[2] !== undefined) {
                    document.getElementById('humidity3').textContent = `${data.h[2].toFixed(1)} %`;
                }
                if (data.i[2] !== undefined) {
                    document.getElementById('illuminance3').textContent = `${data.i[2].toFixed(1)} lx`;
                }
            }
            
            const now = new Date();
            document.getElementById('updateTime').textContent = 
                `更新时间: ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        }
        
        // 更新状态显示
        function updateStatus(text, isSuccess = true) {
            statusText.textContent = text;
            const statusDiv = document.getElementById('connectionStatus');
            
            statusDiv.className = 'status';
            if (isSuccess) {
                statusDiv.classList.add(isConnected ? 'success' : 'warning');
            } else {
                statusDiv.classList.add('error');
            }
        }
        
        // 保存配置
        function saveConfig() {
            const server = mqttServerInput.value.trim();
            const topic = mqttTopicInput.value.trim();
            
            if (!server) {
                alert('请输入MQTT服务器地址');
                return;
            }
            
            if (!topic) {
                alert('请输入主题名称');
                return;
            }
            
            // 保存新配置
            config.server = server;
            config.topic = topic;
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            
            // 如果已连接则重新连接
            if (isConnected) {
                disconnect();
                setTimeout(connect, 500);
            }
            
            configModal.style.display = 'none';
            alert('配置已保存');
        }
        
        // 事件监听
        connectBtn.addEventListener('click', toggleConnection);
        configBtn.addEventListener('click', () => {
            configModal.style.display = 'block';
        });
        cancelBtn.addEventListener('click', () => {
            configModal.style.display = 'none';
        });
        saveBtn.addEventListener('click', saveConfig);
        
        // 点击模态框外部关闭
        window.addEventListener('click', (event) => {
            if (event.target === configModal) {
                configModal.style.display = 'none';
            }
        });
        
        // 自动连接
        window.addEventListener('load', () => {
            connect();
        });
        
        // 数据超时检查
        setInterval(() => {
            if (lastUpdateTime && (Date.now() - lastUpdateTime > 10000)) {
                document.getElementById('temperature1').textContent = '-- °C';
                document.getElementById('humidity1').textContent = '-- %';
                document.getElementById('illuminance1').textContent = '-- lx';
                document.getElementById('temperature2').textContent = '-- °C';
                document.getElementById('humidity2').textContent = '-- %';
                document.getElementById('illuminance2').textContent = '-- lx';
                document.getElementById('temperature3').textContent = '-- °C';
                document.getElementById('humidity3').textContent = '-- %';
                document.getElementById('illuminance3').textContent = '-- lx';
                document.getElementById('updateTime').textContent = '--';
                updateStatus("数据接收超时", false);
                lastUpdateTime = 0;
            }
        }, 5000);
    </script>
</body>
</html>
