<!DOCTYPE html>
<html>
<head>
    <title>MQTT浏览器测试</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #messages { height: 300px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; }
        .message { margin: 5px 0; padding: 5px; background: #f5f5f5; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>MQTT浏览器测试</h1>
    <div>
        <button id="connectBtn">连接MQTT</button>
        <span id="status">状态: 未连接</span>
    </div>
    <div id="messages"></div>

    <script>
        const topic = "esp8266/sensor/data/202509062242";
        let client = null;

        document.getElementById('connectBtn').addEventListener('click', function() {
            if (client && client.connected) {
                client.end();
                this.textContent = "连接MQTT";
                updateStatus("状态: 已断开");
                return;
            }

            updateStatus("状态: 正在连接...");
            this.disabled = true;

            // 使用WebSocket连接（浏览器必须用此方式）
            client = mqtt.connect('wss://test.mosquitto.org:8081/mqtt', {
                clientId: 'browser_test_' + Math.random().toString(16).substr(2, 8)
            });

            client.on('connect', () => {
                updateStatus("状态: 已连接");
                document.getElementById('connectBtn').textContent = "断开连接";
                document.getElementById('connectBtn').disabled = false;
                client.subscribe(topic, (err) => {
                    if (err) {
                        logMessage(`订阅失败: ${err.message}`, true);
                    } else {
                        logMessage(`已订阅主题: ${topic}`);
                    }
                });
            });

            client.on('message', (receivedTopic, payload) => {
                const data = JSON.parse(payload.toString());
                logMessage(`收到消息 [${receivedTopic}]: ${JSON.stringify(data)}`);
                console.log("解析数据:", {
                    temperature: data.t,
                    humidity: data.h,
                    illuminance: data.i,
                    timestamp: new Date(data.ts).toLocaleString()
                });
            });

            client.on('error', (err) => {
                logMessage(`错误: ${err.message}`, true);
                updateStatus("状态: 连接失败");
                document.getElementById('connectBtn').disabled = false;
            });

            client.on('close', () => {
                updateStatus("状态: 已断开");
                document.getElementById('connectBtn').textContent = "连接MQTT";
                document.getElementById('connectBtn').disabled = false;
            });
        });

        function logMessage(message, isError = false) {
            const div = document.createElement('div');
            div.className = isError ? 'message error' : 'message';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('messages').appendChild(div);
        }

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }
    </script>
</body>
</html>
